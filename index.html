<!DOCTYPE html>
<html ng-app="myApp">
<head>
<meta charset="UTF-8" />
<title>ランキング - そこんところ工房</title>
<link rel="stylesheet" href="./main.css">


<script src="./bower_components/angular/angular.js"></script>
<script src="./bower_components/jquery/dist/jquery.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
        <!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">

<!-- Optional theme -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css">

<!-- Latest compiled and minified JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
<script>

// URLのクエリ(game_name)を取得する
function getQueryGameName() {
    var query = window.location.search.substring(1);
    var vars = query.split("&");
    for (var i=0;i<vars.length;i++) {
        var pair = vars[i].split("=");
        if (pair[0] === "game_name") {
            return pair[1];
        }
    }
}

function getGameTitle(){
	var gameTitle = ""
	switch(getQueryGameName()){
		case "honocar":
			gameTitle = "ほのCar!"
	}
	return gameTitle;
}


// myAppモジュールを新規に作成
var module = angular.module('myApp', []);

// myAppモジュールにmyControllerコントローラーを登録1
module.controller('myController', function($scope, $http) {

	var game_name = getQueryGameName();


	$scope.gameTitle = getGameTitle();

	if(game_name != undefined){
		// ランキング
	    $http({
	        url: "http://ec2-54-65-78-59.ap-northeast-1.compute.amazonaws.com:8080/api/scores/"+game_name+"/ranking",
	        method: 'GET'
	    }).success(function (data, status, headers, config) {
	    	var i = 1
	    	for(var key in data){

	    		data[key].ranking = i;
	    		i ++;
	    	}
	    	$scope.rankingTable = data;
	    }).error(function (data, status, headers, config) {
	    });

		// ログイン中のアカウントのランキング情報
	    $http({
	        url: "http://ec2-54-65-78-59.ap-northeast-1.compute.amazonaws.com:8080/api/scores/" + game_name +"/me",
	        method: 'GET',
	        withCredentials: true
	    }).success(function (data, status, headers, config) {
	    	$scope.myRankingInfo = data;
	    	$scope.isLogin = true;
	    }).error(function (data, status, headers, config) {
	    	$scope.isLogin = false;
	    });
	}
});

</script>

</head>
<body>

<div ng-controller="myController">

<h1>スコアランキング</h1>


	<nav class="navbar navbar-default" role="navigation">
        <div class="container-fluid">


			<!-- グローバルナビの中身 -->
			<div class="collapse navbar-collapse" id="nav-menu-1">
            
	            <!-- 各ナビゲーションメニュー -->
	            <ul class="nav navbar-nav">

					<!-- ドロップダウンのメニューも配置可能 -->
					<li class="dropdown">
		                <a href="#" class="dropdown-toggle" data-toggle="dropdown">SELECT GAME <b class="caret"></b></a>
		                <ul class="dropdown-menu">
							<li class="active"><a href="?game_name=honocar">ほのCar!</a></li>
							<li><a href="?game_name=next">next?</a></li>
		                </ul>
					</li>
	            </ul>
	            <ul class="nav navbar-nav navbar-right">
					<li ng-show="!isLogin"><a href="http://ec2-54-65-78-59.ap-northeast-1.compute.amazonaws.com:8080/api/oauth/login?game_name=ranking">LOGIN</a></li>
					<li ng-show="isLogin"><a href="http://ec2-54-65-78-59.ap-northeast-1.compute.amazonaws.com:8080/api/oauth/logout?game_name=ranking">LOGOUT</a></li>
	        	</ul>
			</div>
        </div>
	</nav>

	<h2>{{gameTitle}} TOP 10 </h2>
    <table class="table">
		<tr>
			<th>RANKING</th>
			<th>NAME</th>
			<th>SCORE</th>
	    </tr>
	    <tr ng-repeat="result in rankingTable">
            <td>{{result.ranking}}</td>
		    <td>{{result.user_name}}</td>
            <td>{{result.point}}</td>
        </tr>
    </table>

    <div ng-show="isLogin">
		<h2>My ranking</h2>
		{{myRankingInfo.ranking}}
	</div>

</div>

</body>
</html>